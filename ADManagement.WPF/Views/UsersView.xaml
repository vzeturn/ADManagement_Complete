<UserControl x:Class="ADManagement.WPF.Views.UsersView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:ADManagement.WPF.Converters"
             mc:Ignorable="d">
    <UserControl.Resources>
        <!-- Converters -->
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <local:InverseBoolConverter x:Key="InverseBoolConverter"/>
        <local:EqualsZeroConverter x:Key="EqualsZeroConverter"/>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- Toolbar -->
            <RowDefinition Height="Auto"/>
            <!-- Progress Bar -->
            <RowDefinition Height="*"/>
            <!-- DataGrid -->
            <RowDefinition Height="Auto"/>
            <!-- Action Buttons -->
            <RowDefinition Height="Auto"/>
            <!-- Status Bar -->
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Border Grid.Row="0" Background="{StaticResource SurfaceBrush}" 
                Padding="16,12" BorderThickness="0,0,0,1" BorderBrush="#E0E0E0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Left: Load and Cancel buttons -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Content="ðŸ”„ Load Users" 
                            Command="{Binding LoadUsersCommand}"
                            Style="{StaticResource PrimaryButton}"
                            Height="32" Width="120"
                            Margin="0,0,8,0"/>

                    <!-- Cancel button (only visible when loading) -->
                    <Button Content="âŒ Cancel" 
                            Command="{Binding CancelLoadingCommand}"
                            Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}"
                            Background="#F44336"
                            Foreground="White"
                            Height="32" Width="100"
                            Margin="0,0,8,0"/>

                    <Button Content="ðŸ”„ Refresh" 
                            Command="{Binding RefreshCommand}"
                            Style="{StaticResource SecondaryButton}"
                            Height="32" Width="100"/>
                </StackPanel>

                <!-- Center: Search box -->
                <TextBox Grid.Column="1" 
                         Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}"
                         Margin="16,0"
                         Height="32"
                         VerticalContentAlignment="Center"
                         FontSize="14"/>

                <!-- Right: Stats -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <!-- User count display -->
                    <TextBlock Text="{Binding LoadedCount, StringFormat='Users: {0:N0}'}"
                               VerticalAlignment="Center"
                               FontWeight="SemiBold"
                               FontSize="14"
                               Margin="0,0,12,0"/>

                    <CheckBox Content="Include Disabled"
                              IsChecked="{Binding IncludeDisabledAccounts}"
                              VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Progress Bar (only visible when loading) -->
        <Border Grid.Row="1" Padding="16,8" 
                Background="#F5F5F5"
                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel>
                <Grid Margin="0,0,0,4">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Loading message -->
                    <TextBlock Grid.Column="0"
                               Text="{Binding LoadingMessage}" 
                               FontWeight="SemiBold"/>

                    <!-- Progress percentage -->
                    <TextBlock Grid.Column="1"
                               Text="{Binding LoadingProgress, StringFormat='{}{0:F0}%'}"
                               FontWeight="SemiBold"/>
                </Grid>

                <!-- Progress bar -->
                <ProgressBar Value="{Binding LoadingProgress}" 
                             Maximum="100"
                             Height="8"
                             IsIndeterminate="{Binding LoadingProgress, Converter={StaticResource EqualsZeroConverter}}"/>
            </StackPanel>
        </Border>

        <!-- DataGrid with Virtualization -->
        <DataGrid Grid.Row="2" 
                  ItemsSource="{Binding UsersView}"
                  SelectedItem="{Binding SelectedUser}"
                  AutoGenerateColumns="False"
                  IsReadOnly="True"
                  SelectionMode="Single"
                  GridLinesVisibility="Horizontal"
                  AlternatingRowBackground="#F9F9F9"
                  BorderBrush="#E0E0E0"
                  BorderThickness="1"
                  RowHeight="40"
                  ColumnHeaderHeight="44"
                  VirtualizingPanel.IsVirtualizing="True"
                  VirtualizingPanel.VirtualizationMode="Recycling"
                  VirtualizingPanel.CacheLength="20,20"
                  VirtualizingPanel.CacheLengthUnit="Item"
                  EnableRowVirtualization="True"
                  EnableColumnVirtualization="True"
                  ScrollViewer.CanContentScroll="True"
                  ScrollViewer.IsDeferredScrollingEnabled="False">

            <!-- Double-click handler -->
            <DataGrid.InputBindings>
                <MouseBinding MouseAction="LeftDoubleClick" 
                              Command="{Binding OpenUserDetailCommand}"/>
            </DataGrid.InputBindings>

            <!-- Context Menu -->
            <DataGrid.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="ðŸ“‹ View Details" 
                              Command="{Binding OpenUserDetailCommand}"/>
                    <Separator/>
                    <MenuItem Header="âœ“ Enable User" 
                              Command="{Binding EnableUserCommand}"/>
                    <MenuItem Header="âœ— Disable User" 
                              Command="{Binding DisableUserCommand}"/>
                    <MenuItem Header="ðŸ”“ Unlock User" 
                              Command="{Binding UnlockUserCommand}"/>
                    <Separator/>
                    <MenuItem Header="ðŸ”„ Refresh" 
                              Command="{Binding LoadUsersCommand}"/>
                </ContextMenu>
            </DataGrid.ContextMenu>

            <DataGrid.Columns>
                <!-- Display Name -->
                <DataGridTextColumn Header="Display Name" 
                                    Binding="{Binding DisplayName}" 
                                    Width="200"/>

                <!-- Username -->
                <DataGridTextColumn Header="Username" 
                                    Binding="{Binding Username}" 
                                    Width="150"/>

                <!-- Email -->
                <DataGridTextColumn Header="Email" 
                                    Binding="{Binding Email}" 
                                    Width="250"/>

                <!-- Department -->
                <DataGridTextColumn Header="Department" 
                                    Binding="{Binding Department}" 
                                    Width="150"/>

                <!-- Title -->
                <DataGridTextColumn Header="Title" 
                                    Binding="{Binding Title}" 
                                    Width="180"/>

                <!-- Status -->
                <DataGridTextColumn Header="Status" 
                                    Binding="{Binding AccountStatus}" 
                                    Width="100"/>

                <!-- Last Logon -->
                <DataGridTextColumn Header="Last Logon" 
                                    Binding="{Binding LastLogon, StringFormat='yyyy-MM-dd HH:mm'}" 
                                    Width="140"/>
            </DataGrid.Columns>

            <!-- Row Style for highlighting -->
            <DataGrid.RowStyle>
                <Style TargetType="DataGridRow">
                    <Setter Property="Cursor" Value="Hand"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsLocked}" Value="True">
                            <Setter Property="Background" Value="#FFF3E0"/>
                        </DataTrigger>
                        <DataTrigger Binding="{Binding IsEnabled}" Value="False">
                            <Setter Property="Foreground" Value="#999999"/>
                        </DataTrigger>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Background" Value="#E3F2FD"/>
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </DataGrid.RowStyle>
        </DataGrid>

        <!-- Action Buttons -->
        <WrapPanel Grid.Row="3" Margin="16" HorizontalAlignment="Left">
            <Button Content="âž• Create User" 
                    Style="{StaticResource PrimaryButton}"
                    Command="{Binding CreateUserCommand}"
                    Margin="0,0,8,0" Height="36" Width="130"/>

            <Button Content="âœ“ Enable User" 
                    Style="{StaticResource PrimaryButton}"
                    Command="{Binding EnableUserCommand}"
                    Margin="0,0,8,0" Height="36" Width="130"/>

            <Button Content="âœ— Disable User" 
                    Style="{StaticResource SecondaryButton}"
                    Command="{Binding DisableUserCommand}"
                    Margin="0,0,8,0" Height="36" Width="130"/>

            <Button Content="ðŸ”“ Unlock User" 
                    Style="{StaticResource SecondaryButton}"
                    Command="{Binding UnlockUserCommand}"
                    Height="36" Width="130"/>
        </WrapPanel>

        <!-- Status Bar -->
        <Border Grid.Row="4" Background="{StaticResource SurfaceBrush}" 
                Padding="16,8" BorderThickness="0,1,0,0" BorderBrush="#E0E0E0">
            <TextBlock Text="{Binding StatusMessage}" 
                       FontSize="12"
                       VerticalAlignment="Center"/>
        </Border>
    </Grid>
</UserControl>